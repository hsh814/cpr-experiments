project_name=binutils
bug_id=CVE-2017-15025
dir_name=$1/extractfix/$project_name/$bug_id

project_url=https://sourceware.org/git/binutils-gdb.git
commit_id=515f23e63c0074ab531bc954f84ca40c6281a724

current_dir=$PWD
mkdir -p $dir_name
cd $dir_name
git clone $project_url src
cd src
git checkout $commit_id

CC=wllvm CXX=wllvm++ CFLAGS="-g -O0" CXXFLAGS="$CFLAGS" ./configure --disable-shared --disable-gdb --disable-libdecnumber --disable-readline --disable-sim --disable-werror
make -j32

sed -i '2440i __trident_output("obs", "i32", lh.line_range);' bfd/dwarf2.c
sed -i '2440i if(__trident_choice("L2440", "bool", (int[]){lh.line_range, lh.maximum_ops_per_insn}, (char*[]){"x", "y"}, 2, (int*[]){}, (char*[]){}, 0)) goto line_fail;' bfd/dwarf2.c
sed -i '38i #ifndef TRIDENT_OUTPUT\n#define TRIDENT_OUTPUT(id, typestr, value) value\n#endif\n' bfd/dwarf2.c
git add bfd/dwarf2.c
git commit -m "instrument trident"

make CXX=$TRIDENT_CXX CC=$TRIDENT_CC LDFLAGS='-lkleeRuntest -L/klee/build/lib -ltrident_runtime -L/CPR/lib' -j32
cd binutils

make CXX=$TRIDENT_CXX CC=$TRIDENT_CC  -j32

cd $current_dir
cp repair.conf $dir_name
cp spec.smt2 $dir_name
cp t1.smt2 $dir_name
cp -rf components $dir_name
cp exploit.bin $dir_name

