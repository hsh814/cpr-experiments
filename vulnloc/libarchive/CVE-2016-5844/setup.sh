project_name=libarchive
bug_id=CVE-2016-5844
dir_name=$1/vulnloc/$project_name/$bug_id

current_dir=$PWD
mkdir -p $dir_name
cd $dir_name
wget https://libarchive.org/downloads/libarchive-3.2.0.zip
unzip libarchive-3.2.0.zip
mv libarchive-3.2.0 src
cd src

CC=wllvm CXX=wllvm++ ./configure --without-openssl --without-xml2 CFLAGS='-g -O0 -static' CXXFLAGS='-g -O0 -static'

sed -i '1093i klee_assert( vd->location < 1048576 );\n' libarchive/archive_read_support_format_iso9660.c
sed -i '1093i TRIDENT_OUTPUT("obs", "i32", 1048576-vd->location);' libarchive/archive_read_support_format_iso9660.c

sed -i '1093i if(__trident_choice("L515", "bool", (int[]){temp, vd->location, skipsize, iso9660->current_position, iso9660->entry_sparse_offset}, (char*[]){"x", "y", "z", "m", "n"}, 5, (int*[]){}, (char*[]){}, 0)) return (ARCHIVE_FATAL);' libarchive/archive_read_support_format_iso9660.c

sed -i '1093i int temp = 1048576 - vd->location;' libarchive/archive_read_support_format_iso9660.c

sed -i '54i #ifndef TRIDENT_OUTPUT\n#define TRIDENT_OUTPUT(id, typestr, value) value\n#endif\n' libarchive/archive_read_support_format_iso9660.c
sed -i '54i #include <klee/klee.h>' libarchive/archive_read_support_format_iso9660.c
# git add libarchive/archive_read_support_format_iso9660.c
# git commit -m "instrument trident"

make CXX=$TRIDENT_CXX CC=$TRIDENT_CC CFLAGS='-I/klee/source/include' CXXFLAGS='-I/klee/source/include' LDFLAGS='-lkleeRuntest -L/klee/build/lib -ltrident_runtime -L/CPR/lib' -j32

cd $current_dir
cp repair.conf $dir_name
cp spec.smt2 $dir_name
cp t1.smt2 $dir_name
cp -rf components $dir_name
cp libarchive-signed-int-overflow.iso $dir_name
