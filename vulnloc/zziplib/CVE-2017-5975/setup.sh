project_name=zziplib
bug_id=CVE-2017-5975
dir_name=$1/vulnloc/$project_name/$bug_id

current_dir=$PWD
mkdir -p $dir_name
cd $dir_name
git clone https://github.com/gdraheim/zziplib.git src
cd src
git checkout 33d6e9c
cd docs/
wget https://github.com/LuaDist/libzzip/raw/master/docs/zziplib-manpages.tar
cd ../

CC=wllvm CXX=wllvm++ ./configure CFLAGS='-g -O0 -static'

sed -i '182i TRIDENT_OUTPUT("obs", "i32", header);' zzip/memdisk.c
sed -i '180i if(__trident_choice("L1634", "bool", (int[]){header, disk, entry, disk->endbuf, item->zz_usize, item->zz_csize}, (char*[]){"x", "y", "z", "l", "m", "n"}, 6, (int*[]){}, (char*[]){}, 0)) return 0;' zzip/memdisk.c
sed -i '44i #ifndef TRIDENT_OUTPUT\n#define TRIDENT_OUTPUT(id, typestr, value) value\n#endif\n' zzip/memdisk.c
# git add libtiff/tif_dirwrite.c
# git commit -m "instrument trident"

make CC=$TRIDENT_CC CFLAGS="-lkleeRuntest -L/klee/build/lib -ltrident_proxy -L/CPR/lib -g -O0" -j32

cd $current_dir
cp repair.conf $dir_name
cp spec.smt2 $dir_name
cp t1.smt2 $dir_name
cp -rf components $dir_name
cp exploit $dir_name
