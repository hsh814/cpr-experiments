project_name=zziplib
bug_id=CVE-2017-5976
dir_name=$1/vulnloc/$project_name/$bug_id

current_dir=$PWD
mkdir -p $dir_name
cd $dir_name
git clone https://github.com/gdraheim/zziplib.git src
cd src
git checkout 3a4ffcd
cd docs/
wget https://github.com/LuaDist/libzzip/raw/master/docs/zziplib-manpages.tar
cd ../

CC=wllvm CXX=wllvm++ ./configure CFLAGS='-g -O0 -static'


sed -i '257s/.*/ext += datasize;/' zzip/memdisk.c
sed -i '256s/.*/ext += zzip_extra_block_headerlength;/' zzip/memdisk.c
sed -i '255s/.*/___ zzip_size_t datasize = zzip_extra_block_get_datasize(ext);/' zzip/memdisk.c
sed -i '254s/.*//' zzip/memdisk.c

sed -i '250i klee_assert( ext_end-ext-zzip_extra_block_headerlength >= 0 );\n' zzip/memdisk.c
sed -i '250i TRIDENT_OUTPUT("obs", "i32", ext_end-ext-zzip_extra_block_headerlength);' zzip/memdisk.c
# sed -i '259i if (__trident_choice("L1634", "bool", (int[]){ext, zzip_extra_block_headerlength, ext_end, i, datatype}, (char*[]){"x", "y", "z", "m", "n"}, 5, (int*[]){}, (char*[]){}, 0)) return 0;' zzip/memdisk.c

sed -i '248s/.*/while (__trident_choice("L1634", "bool", (int[]){ext, zzip_extra_block_headerlength, ext_end, i, datatype}, (char*[]){"x", "y", "z", "m", "n"}, 5, (int*[]){}, (char*[]){}, 0))/' zzip/memdisk.c
sed -i '245s/.*/char* ext = (char*)( entry->zz_ext[i] ); char* ext_end = ext + entry->zz_extlen[i];/' zzip/memdisk.c

sed -i '212i item->zz_extlen[2] = ext2;' zzip/memdisk.c
sed -i '201i item->zz_extlen[1] = ext1;' zzip/memdisk.c

sed -i '44i #ifndef TRIDENT_OUTPUT\n#define TRIDENT_OUTPUT(id, typestr, value) value\n#endif\n' zzip/memdisk.c
sed -i '44i #include <klee/klee.h>' zzip/memdisk.c

sed -i '69i zzip_size_t       zz_extlen[3];' zzip/memdisk.h

make CC=$TRIDENT_CC CFLAGS="-lkleeRuntest -L/klee/build/lib -I/klee/source/include -ltrident_proxy -L/CPR/lib -g -O0 -static" -j32

cd $current_dir
cp repair.conf $dir_name
cp spec.smt2 $dir_name
cp t1.smt2 $dir_name
cp -rf components $dir_name
cp exploit $dir_name
