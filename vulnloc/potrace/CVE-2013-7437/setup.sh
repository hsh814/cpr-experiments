project_name=potrace
bug_id=CVE-2013-7437
dir_name=$1/vulnloc/$project_name/$bug_id

current_dir=$PWD
mkdir -p $dir_name
cp $PWD/source.zip $dir_name
cd $dir_name
unzip source.zip
mv source src
cd src


CC=wllvm CXX=wllvm++ ./configure CFLAGS='-g -O0 -static'
CC=wllvm CXX=wllvm++ make -j32

sed -i 's/fabs/fabs_trident/g' src/backend_geojson.c
sed -i 's/fabs/fabs_trident/g' src/render.c
sed -i 's/fabs/fabs_trident/g' src/trace.c
sed -i 's/fabs/fabs_trident/g' src/trans.c

make CFLAGS="-lkleeRuntest -L/klee/build/lib -ltrident_proxy -L/CPR/lib -g -O0" -j32

sed -i '994i TRIDENT_OUTPUT("obs", "i32", 0x7fffffff-bmpinfo.w);' src/bitmap_io.c
sed -i '481i if(__trident_choice("L1634", "bool", (int[]){bmpinfo.w, threshold, 0x7fffffff, bmpinfo.h, bmpinfo.InfoSize, bmp_pos}, (char*[]){"x", "y", "z", "l", "m", "n"}, 6, (int*[]){}, (char*[]){}, 0)) goto format_error;' src/bitmap_io.c
sed -i '14i #ifndef TRIDENT_OUTPUT\n#define TRIDENT_OUTPUT(id, typestr, value) value\n#endif\n' src/bitmap_io.c
# git add libtiff/tif_dirwrite.c
# git commit -m "instrument trident"

make CC=$TRIDENT_CC -j32

cd $current_dir
cp repair.conf $dir_name
cp spec.smt2 $dir_name
cp t1.smt2 $dir_name
cp -rf components $dir_name
cp exploit $dir_name
