project_name=libming
bug_id=CVE-2016-9264
dir_name=$1/vulnloc/$project_name/$bug_id

current_dir=$PWD
mkdir -p $dir_name
cd $dir_name
git clone https://github.com/libming/libming.git
mv libming src
cd src
git checkout cc6a386

./autogen.sh
CC=wllvm CXX=wllvm++ CFLAGS='-g -O0 -static' CXXFLAGS='-g -O0 -static' ./configure --disable-freetype
CC=wllvm CXX=wllvm++ make

sed -i '128i TRIDENT_OUTPUT("obs", "i32", samplerate_idx-2);' util/listmp3.c

sed -i '124i if(samplerate_idx < 0 || __trident_choice("L515", "bool", (int[]){samplerate_idx, layer, bitrate, bitrate_idx, channels}, (char*[]){"x", "y", "z", "m", "n"}, 5, (int*[]){}, (char*[]){}, 0)) error("invalid samplerate index");' util/listmp3.c

sed -i '55i #ifndef TRIDENT_OUTPUT\n#define TRIDENT_OUTPUT(id, typestr, value) value\n#endif\n'  util/listmp3.c
# git add  util/listmp3.c
# git commit -m "instrument trident"

make CXX=$TRIDENT_CXX  CC=$TRIDENT_CC CXXFLAGS="-g -I /CPR/runtime -L/CPR/runtime -ltrident_runtime -lkleeRuntest -static" \
CFLAGS="-g -I /CPR/runtime -L/CPR/runtime -ltrident_runtime -lkleeRuntest -static"


cd $current_dir
cp repair.conf $dir_name
cp spec.smt2 $dir_name
cp t1.smt2 $dir_name
cp -rf components $dir_name
cp exploit $dir_name
